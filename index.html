<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel PSR - Live Data</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#003366',
                        secondary: '#4682B4',
                        // Mantemos as cores personalizadas para uso direto nas classes
                        'custom-green': '#28a745',
                        'custom-yellow': '#ffc107',
                        'custom-red': '#d0021b',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Poppins', 'sans-serif'],
                    },
                }
            }
        }
    </script>

    <style type="text/tailwindcss">
        @layer components {
            .text-display { @apply text-4xl font-bold tracking-tight; font-family: 'Poppins', sans-serif; }
            .text-heading { @apply text-xl font-semibold tracking-tight; font-family: 'Poppins', sans-serif; }
            .text-body { @apply font-sans text-sm font-normal leading-relaxed; }
            .text-label { @apply font-sans text-xs font-medium uppercase tracking-wider; }
            
            /* CORREÇÃO CSS: Usando cores padrão do Tailwind no @apply para evitar erros do compilador JIT */
            .card-elevated { 
                @apply rounded-lg border border-gray-200 bg-white text-gray-900 shadow-sm transition-all duration-200; 
            }
            .card-elevated:hover { 
                @apply shadow-md transform -translate-y-1; 
            }
            
            .status-pill { @apply px-2 py-1 rounded-md text-xs font-bold inline-flex items-center gap-1; }
            .btn-action { @apply flex-1 py-2 rounded-md font-medium transition-colors text-sm flex items-center justify-center gap-2; }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeInUp { animation: fadeInUp 0.5s ease-out forwards; }
        
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #003366;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // --- CONFIGURAÇÃO DE CAMPOS ---
        const FIELD_KEYS = {
            TITLE: ['Título', 'Nome', 'Title'],
            ASSUNTO: ['Assunto'],
            STATUS: ['Status', 'Status:'],
            OBSERVACAO: ['Observação', 'Observacao', 'Observacão'],
            APROVACAO: ['Aprovação', 'Aprovacao'],
            PLATAFORMA: ['Plataforma', 'Plataformas'],
            LINK_DRIVE: ['Link do Drive', 'Link Drive', 'Drive'],
            COMENTARIOS: ['comments', 'Comentários', 'Comentarios'],
            DATA_POSTAGEM: ['Data da Postagem', 'Data Postagem', 'dataPostagem', 'Data', 'Data:'],
            DATA_ENTREGA: ['Data de Entrega', 'Data Entrega', 'dataEntrega', 'Prazo']
        };

        // --- HELPERS ---
        function getFieldValue(item, possibleKeysArray, defaultValue = '') {
            for (const key of possibleKeysArray) {
                if (item && item.hasOwnProperty(key) && item[key] !== null && item[key] !== undefined && String(item[key]).trim() !== '') {
                    return item[key];
                }
            }
            return defaultValue;
        }

        function parseDate(dateStr) {
            if (!dateStr) return null;
            if (dateStr instanceof Date) return dateStr;
            if (typeof dateStr === 'string') {
                try {
                    let d = null;
                    if (dateStr.includes('/')) {
                        const parts = dateStr.split('/');
                        if (parts.length === 3) d = new Date(parts[2], parseInt(parts[1])-1, parts[0]);
                        else if (parts.length === 2) d = new Date(new Date().getFullYear(), parseInt(parts[1])-1, parts[0]);
                    } else if (dateStr.match(/^\d{4}-\d{2}-\d{2}/)) {
                        d = new Date(dateStr);
                    }
                    return (d && !isNaN(d.getTime())) ? d : null;
                } catch (e) { return null; }
            }
            return null;
        }

        const formatDate = (dateInput) => {
            const d = parseDate(dateInput);
            if (!d) return 'N/A';
            return d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: '2-digit' });
        };

        // --- CORREÇÃO DO COMPONENTE DE ÍCONE ---
        const Icon = ({ name, size = 18, className = "", style = {} }) => {
            const iconRef = React.useRef(null);
            
            // Função para converter CamelCase para kebab-case (ex: LayoutDashboard -> layout-dashboard)
            const toKebabCase = (str) => {
                return str.replace(/([a-z0-9])([A-Z])/g, '$1-$2').toLowerCase();
            };

            useEffect(() => {
                if (iconRef.current && window.lucide) {
                    const kebabName = toKebabCase(name);
                    lucide.createIcons({
                        attrs: { 
                            size, 
                            class: className, 
                            style: Object.entries(style).map(([k,v]) => `${k}:${v}`).join(';') 
                        },
                        nameAttr: 'data-lucide',
                        // Força a renderização apenas neste elemento
                        icons: { [kebabName]: lucide.icons[name] } 
                    });
                    
                    // Fallback genérico caso o mapeamento acima falhe
                    if (!iconRef.current.innerHTML) {
                        lucide.createIcons({
                            attrs: { size, class: className },
                            nameAttr: 'data-lucide'
                        });
                    }
                }
            }, [name, size, className, style]);

            // Renderiza com o nome em kebab-case para o Lucide encontrar
            return <i data-lucide={toKebabCase(name)} ref={iconRef}></i>;
        };

        // --- APP PRINCIPAL ---
        function App() {
            const [rawTasks, setRawTasks] = useState([]);
            const [loading, setLoading] = useState(true);
            const [selectedTask, setSelectedTask] = useState(null);
            const [modalMessage, setModalMessage] = useState(null);

            // Filters State
            const [filterMonth, setFilterMonth] = useState('');
            const [filterStatus, setFilterStatus] = useState('all');
            const [filterPlatform, setFilterPlatform] = useState('all');
            const [showCompleted, setShowCompleted] = useState(false); // Padrão: Ocultar concluídos

            // --- DATA FETCHING ---
            const loadData = useCallback(() => {
                setLoading(true);
                fetch('https://agenda-portal-2d149-default-rtdb.firebaseio.com/agenda.json')
                .then(r => r.json())
                .then(json => {
                    if (json) {
                        const items = Object.values(json).map(item => ({
                            ...item,
                            _internalId: item._internalId || Math.random().toString(36).substr(2, 9)
                        }));
                        setRawTasks(items);
                        
                        if (filterMonth === '') {
                            const now = new Date();
                            setFilterMonth(`${now.getFullYear()}-${now.getMonth()}`);
                        }
                    }
                })
                .catch(err => {
                    console.error("Erro Firebase:", err);
                    setModalMessage({ type: 'error', text: 'Erro ao carregar dados.' });
                })
                .finally(() => setLoading(false));
            }, [filterMonth]);

            useEffect(() => {
                loadData();
            }, [loadData]);

            // --- COMPUTED DATA (FILTROS) ---
            const { filteredTasks, stats, availableMonths, availablePlatforms, availableStatuses } = useMemo(() => {
                let filtered = [...rawTasks];
                const statsCounter = { total: 0, pending: 0, inProgress: 0, completed: 0 };
                const monthsSet = new Map();
                const platformsSet = new Set();
                const statusesSet = new Set();

                rawTasks.forEach(task => {
                    const s = getFieldValue(task, FIELD_KEYS.STATUS);
                    if(s) statusesSet.add(s);
                    
                    const p = getFieldValue(task, FIELD_KEYS.PLATAFORMA);
                    if(p) p.split(',').forEach(x => platformsSet.add(x.trim()));

                    const d = parseDate(getFieldValue(task, FIELD_KEYS.DATA_ENTREGA));
                    if(d) {
                        const key = `${d.getFullYear()}-${d.getMonth()}`;
                        if(!monthsSet.has(key)) {
                            monthsSet.set(key, { 
                                value: key, 
                                label: d.toLocaleString('pt-BR', { month: 'long', year: 'numeric' }),
                                sort: d.getTime()
                            });
                        }
                    }
                });

                // Apply Filters
                if (filterMonth) {
                    const [year, month] = filterMonth.split('-').map(Number);
                    filtered = filtered.filter(t => {
                        const d = parseDate(getFieldValue(t, FIELD_KEYS.DATA_ENTREGA));
                        return d && d.getMonth() === month && d.getFullYear() === year;
                    });
                }

                if (filterStatus !== 'all') {
                    filtered = filtered.filter(t => getFieldValue(t, FIELD_KEYS.STATUS) === filterStatus);
                }

                if (filterPlatform !== 'all') {
                    filtered = filtered.filter(t => {
                        const p = getFieldValue(t, FIELD_KEYS.PLATAFORMA);
                        return p && p.includes(filterPlatform);
                    });
                }

                // Logic to hide/show completed
                if (!showCompleted) {
                    filtered = filtered.filter(t => {
                        const s = String(getFieldValue(t, FIELD_KEYS.STATUS)).toLowerCase();
                        const a = String(getFieldValue(t, FIELD_KEYS.APROVACAO)).toLowerCase();
                        const isDone = (s.includes('conclu') || s.includes('finaliz') || s.includes('postado')) && a.includes('aprovado');
                        return !isDone;
                    });
                }

                filtered.forEach(t => {
                    const s = String(getFieldValue(t, FIELD_KEYS.STATUS)).toLowerCase();
                    const a = String(getFieldValue(t, FIELD_KEYS.APROVACAO)).toLowerCase();
                    
                    statsCounter.total++;
                    if ((s.includes('conclu') || s.includes('finaliz')) && a.includes('aprovado')) statsCounter.completed++;
                    else if (s.includes('programado') || s.includes('andamento') || s.includes('fila')) statsCounter.inProgress++;
                    else statsCounter.pending++;
                });
                
                filtered.sort((a,b) => {
                    const da = parseDate(getFieldValue(a, FIELD_KEYS.DATA_ENTREGA)) || new Date(0);
                    const db = parseDate(getFieldValue(b, FIELD_KEYS.DATA_ENTREGA)) || new Date(0);
                    return da - db;
                });

                return {
                    filteredTasks: filtered,
                    stats: statsCounter,
                    availableMonths: Array.from(monthsSet.values()).sort((a,b) => a.sort - b.sort),
                    availablePlatforms: Array.from(platformsSet).sort(),
                    availableStatuses: Array.from(statusesSet).sort()
                };

            }, [rawTasks, filterMonth, filterStatus, filterPlatform, showCompleted]);

            // --- APPS SCRIPT INTERACTION ---
            const sendDataToSheet = (payload, successMsg) => {
                setModalMessage({ type: 'loading', text: 'Enviando...' });
                
                const webAppBase = 'https://script.google.com/macros/s/AKfycbzO7oR3CNBZD-NCnij7Xa-xScc09EWGU69uq81VDHPZmlmwjYJ4s_4rIYzy2Gp1iXvV/exec';
                const params = new URLSearchParams();
                params.set('action', payload.action);
                params.set('row', payload.row);
                if (payload.action === 'addComment') params.set('comment', payload.comment);
                if (payload.action === 'updateI') params.set('value', payload.value);

                const cbName = 'jsonpCallback_' + Math.random().toString(36).substr(2, 8);
                params.set('callback', cbName);

                window[cbName] = function(resp) {
                    if (resp && resp.status === 'ok') {
                        setModalMessage({ type: 'success', text: successMsg });
                        setTimeout(() => {
                            setModalMessage(null);
                            setSelectedTask(null);
                            loadData();
                        }, 1500);
                    } else {
                        setModalMessage({ type: 'error', text: resp?.message || 'Erro desconhecido.' });
                        setTimeout(() => setModalMessage(null), 3000);
                    }
                    delete window[cbName];
                    document.getElementById(cbName)?.remove();
                };

                const script = document.createElement('script');
                script.id = cbName;
                script.src = `${webAppBase}?${params.toString()}`;
                script.onerror = () => {
                    setModalMessage({ type: 'error', text: 'Erro de conexão com Google Script.' });
                    setTimeout(() => setModalMessage(null), 3000);
                };
                document.body.appendChild(script);
            };

            const handleApprove = (task, isApproved) => {
                const row = task._row;
                if(!row) return alert("Erro: ID da linha não encontrado.");
                
                const now = new Date();
                const timeStr = `${String(now.getDate()).padStart(2, "0")}/${String(now.getMonth() + 1).padStart(2, "0")} às ${String(now.getHours()).padStart(2, "0")}:${String(now.getMinutes()).padStart(2, "0")}h`;
                
                let val = '';
                if(isApproved === 'approve') val = `Aprovado dia ${timeStr}`;
                else if(isApproved === 'reject') val = `Reprovado dia ${timeStr}`;
                else val = 'Pendente';

                if(isApproved === 'custom') {
                    const userVal = prompt("Digite o status de aprovação:", "Aprovado com ressalvas");
                    if(!userVal) return;
                    val = `${userVal} - ${timeStr}`;
                }

                sendDataToSheet({ action: "updateI", row: row, value: val }, "Status Atualizado!");
            };

            const handleComment = (task) => {
                const row = task._row;
                if(!row) return alert("Erro: ID da linha não encontrado.");
                const text = prompt("Digite seu comentário:");
                if(text) {
                    const now = new Date();
                    const timestamp = `${String(now.getDate()).padStart(2,'0')}/${String(now.getMonth()+1).padStart(2,'0')} - ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}h`;
                    sendDataToSheet({ action: 'addComment', row: row, comment: `${timestamp}: ${text}` }, "Comentário adicionado!");
                }
            };

            // --- RENDER STYLES ---
            const getStatusColor = (status, approval) => {
                const s = String(status).toLowerCase();
                const a = String(approval).toLowerCase();
                
                if (a.includes('reprovado')) return { bg: '#FEE2E2', text: '#d0021b', border: '#d0021b', icon: 'XCircle' };
                if (a.includes('aprovado')) return { bg: '#DCFCE7', text: '#166534', border: '#166534', icon: 'CheckCircle2' };
                if (s.includes('conclu') || s.includes('final') || s.includes('postado')) return { bg: '#DCFCE7', text: '#166534', border: '#166534', icon: 'Check' };
                if (s.includes('pendente') || s.includes('aguardando')) return { bg: '#FEF3C7', text: '#B45309', border: '#F59E0B', icon: 'Clock' };
                if (s.includes('andamento') || s.includes('fila')) return { bg: '#E0F2FE', text: '#0369A1', border: '#0EA5E9', icon: 'Loader' };
                
                return { bg: '#F3F4F6', text: '#4B5563', border: '#9CA3AF', icon: 'HelpCircle' }; 
            };

            return (
                <div className="min-h-screen pb-12">
                    {/* --- HEADER --- */}
                    <header className="bg-white border-b border-gray-200 shadow-sm sticky top-0 z-10">
                        <div className="container mx-auto px-4 py-4 flex flex-col md:flex-row items-center justify-between gap-4">
                            <div>
                                <h1 className="text-2xl md:text-3xl font-bold text-primary flex items-center gap-2">
                                    <Icon name="LayoutDashboard" className="text-secondary" /> Painel Marketing
                                </h1>
                                <p className="text-sm text-gray-500 hidden md:block">Gerenciamento de tarefas PSR</p>
                            </div>
                            <div className="flex items-center gap-3">
                                {loading && <div className="loader w-6 h-6 border-2"></div>}
                                <button onClick={loadData} className="p-2 bg-gray-100 hover:bg-gray-200 rounded-full transition" title="Recarregar">
                                    <Icon name="RefreshCw" size={20} className={loading ? "animate-spin" : ""} />
                                </button>
                            </div>
                        </div>
                    </header>

                    {/* --- KPI SECTION --- */}
                    <section className="bg-white border-b border-gray-200">
                        <div className="container mx-auto px-4 py-6">
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div className="card-elevated p-4 border-l-4 border-l-blue-900">
                                    <div className="text-label text-gray-500">Total</div>
                                    <div className="text-2xl font-bold text-primary">{stats.total}</div>
                                </div>
                                <div className="card-elevated p-4 border-l-4 border-l-yellow-500">
                                    <div className="text-label text-gray-500">Pendentes</div>
                                    <div className="text-2xl font-bold text-yellow-700">{stats.pending}</div>
                                </div>
                                <div className="card-elevated p-4 border-l-4 border-l-blue-400">
                                    <div className="text-label text-gray-500">Em Andamento</div>
                                    <div className="text-2xl font-bold text-blue-600">{stats.inProgress}</div>
                                </div>
                                <div className="card-elevated p-4 border-l-4 border-l-green-600">
                                    <div className="text-label text-gray-500">Concluídas</div>
                                    <div className="text-2xl font-bold text-green-700">{stats.completed}</div>
                                </div>
                            </div>
                        </div>
                    </section>

                    {/* --- FILTERS --- */}
                    <section className="bg-gray-50 py-6 border-b border-gray-200">
                        <div className="container mx-auto px-4">
                            <div className="flex flex-col md:flex-row gap-4 items-center justify-between bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                                <div className="flex flex-wrap items-center gap-3 w-full">
                                    <div className="flex items-center gap-2 text-gray-500 mr-2">
                                        <Icon name="Filter" size={18} />
                                        <span className="font-medium text-sm">Filtros:</span>
                                    </div>
                                    
                                    <select 
                                        className="px-3 py-2 rounded-md border border-gray-300 text-sm bg-white focus:ring-2 focus:ring-primary outline-none"
                                        value={filterMonth}
                                        onChange={(e) => setFilterMonth(e.target.value)}
                                    >
                                        <option value="">Todos os Meses</option>
                                        {availableMonths.map(m => (
                                            <option key={m.value} value={m.value}>{m.label}</option>
                                        ))}
                                    </select>

                                    <select 
                                        className="px-3 py-2 rounded-md border border-gray-300 text-sm bg-white focus:ring-2 focus:ring-primary outline-none max-w-[150px]"
                                        value={filterStatus}
                                        onChange={(e) => setFilterStatus(e.target.value)}
                                    >
                                        <option value="all">Todos Status</option>
                                        {availableStatuses.map(s => (
                                            <option key={s} value={s}>{s}</option>
                                        ))}
                                    </select>

                                    <select 
                                        className="px-3 py-2 rounded-md border border-gray-300 text-sm bg-white focus:ring-2 focus:ring-primary outline-none max-w-[150px]"
                                        value={filterPlatform}
                                        onChange={(e) => setFilterPlatform(e.target.value)}
                                    >
                                        <option value="all">Todas Plataformas</option>
                                        {availablePlatforms.map(p => (
                                            <option key={p} value={p}>{p}</option>
                                        ))}
                                    </select>
                                </div>

                                <div className="flex gap-2 w-full md:w-auto">
                                    <button 
                                        onClick={() => setShowCompleted(!showCompleted)}
                                        className={`px-4 py-2 rounded-md text-sm font-medium flex items-center gap-2 transition-all w-full md:w-auto justify-center ${showCompleted ? 'bg-primary text-white' : 'bg-gray-200 text-gray-600'}`}
                                    >
                                        <Icon name={showCompleted ? "Eye" : "EyeOff"} size={16} />
                                        {showCompleted ? "Ocultar Concluídos" : "Mostrar Concluídos"}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </section>

                    {/* --- TASKS GRID --- */}
                    <main className="container mx-auto px-4 py-8">
                        {loading ? (
                            <div className="flex flex-col items-center justify-center py-20">
                                <div className="loader mb-4"></div>
                                <p className="text-gray-500">Carregando tarefas do Firebase...</p>
                            </div>
                        ) : filteredTasks.length === 0 ? (
                            <div className="text-center py-20 bg-white rounded-lg border border-dashed border-gray-300">
                                <Icon name="Inbox" size={48} className="mx-auto text-gray-300 mb-4" />
                                <h3 className="text-lg font-medium text-gray-900">Nenhuma tarefa encontrada</h3>
                                <p className="text-gray-500">Tente ajustar os filtros acima.</p>
                            </div>
                        ) : (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {filteredTasks.map((task, index) => {
                                    const status = getFieldValue(task, FIELD_KEYS.STATUS, 'Sem Status');
                                    const approval = getFieldValue(task, FIELD_KEYS.APROVACAO, 'Pendente');
                                    const title = getFieldValue(task, FIELD_KEYS.TITLE, 'Sem Título');
                                    const platform = getFieldValue(task, FIELD_KEYS.PLATAFORMA, 'Geral');
                                    const dueDate = getFieldValue(task, FIELD_KEYS.DATA_ENTREGA);
                                    
                                    const style = getStatusColor(status, approval);
                                    
                                    return (
                                        <div 
                                            key={task._internalId}
                                            onClick={() => setSelectedTask(task)}
                                            className="card-elevated p-5 cursor-pointer group bg-white relative overflow-hidden animate-fadeInUp flex flex-col h-full"
                                            style={{ animationDelay: `${index * 50}ms`, borderTop: `4px solid ${style.border}` }}
                                        >
                                            <div className="flex justify-between items-start mb-3">
                                                <span className="text-xs font-bold uppercase text-gray-500 tracking-wider bg-gray-100 px-2 py-1 rounded">
                                                    {platform}
                                                </span>
                                                <div className="status-pill" style={{ backgroundColor: style.bg, color: style.text }}>
                                                    <Icon name={style.icon} size={12} />
                                                    {status}
                                                </div>
                                            </div>

                                            <h3 className="text-lg font-bold text-gray-800 mb-2 leading-tight line-clamp-2 flex-grow">
                                                {title}
                                            </h3>

                                            <div className="space-y-2 mt-4 text-sm text-gray-600">
                                                <div className="flex items-center gap-2">
                                                    <Icon name="Calendar" size={14} className="text-gray-400" />
                                                    <span className={!parseDate(dueDate) ? "text-gray-400" : "font-medium"}>
                                                        Entrega: {formatDate(dueDate)}
                                                    </span>
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    <Icon name="FileCheck" size={14} className="text-gray-400" />
                                                    <span className={`${approval.toLowerCase().includes('reprovado') ? 'text-red-600 font-bold' : ''}`}>
                                                        {approval}
                                                    </span>
                                                </div>
                                            </div>

                                            <div className="mt-4 pt-3 border-t border-gray-100 flex justify-between items-center text-xs text-primary font-medium opacity-0 group-hover:opacity-100 transition-opacity">
                                                <span>Ver detalhes</span>
                                                <Icon name="ArrowRight" size={14} />
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </main>

                    {/* --- MODAL DE DETALHES --- */}
                    {selectedTask && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm" onClick={() => setSelectedTask(null)}>
                            <div className="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto animate-fadeInUp" onClick={e => e.stopPropagation()}>
                                {/* Modal Header */}
                                <div className="p-6 border-b border-gray-200 bg-gray-50 flex justify-between items-start sticky top-0 z-10">
                                    <div>
                                        <div className="flex gap-2 mb-2">
                                            <span className="bg-primary/10 text-primary px-2 py-1 rounded text-xs font-bold uppercase">
                                                {getFieldValue(selectedTask, FIELD_KEYS.PLATAFORMA)}
                                            </span>
                                            <span className="bg-gray-200 text-gray-700 px-2 py-1 rounded text-xs font-bold">
                                                ID: {selectedTask._row || 'N/A'}
                                            </span>
                                        </div>
                                        <h2 className="text-2xl font-bold text-gray-900">{getFieldValue(selectedTask, FIELD_KEYS.TITLE)}</h2>
                                    </div>
                                    <button onClick={() => setSelectedTask(null)} className="text-gray-400 hover:text-gray-700 transition">
                                        <Icon name="X" size={24} />
                                    </button>
                                </div>

                                {/* Modal Content */}
                                <div className="p-6 space-y-6">
                                    {/* Status Block */}
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="p-3 bg-gray-50 rounded-lg border border-gray-200">
                                            <div className="text-label text-gray-500 mb-1">Status Atual</div>
                                            <div className="font-semibold text-gray-800">{getFieldValue(selectedTask, FIELD_KEYS.STATUS)}</div>
                                        </div>
                                        <div className={`p-3 rounded-lg border ${String(getFieldValue(selectedTask, FIELD_KEYS.APROVACAO)).toLowerCase().includes('reprovado') ? 'bg-red-50 border-red-200 text-red-700' : 'bg-green-50 border-green-200 text-green-700'}`}>
                                            <div className="text-label mb-1 opacity-80">Aprovação</div>
                                            <div className="font-bold">{getFieldValue(selectedTask, FIELD_KEYS.APROVACAO)}</div>
                                        </div>
                                    </div>

                                    {/* Info Grid */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-y-4 gap-x-8 text-sm">
                                        <div>
                                            <h4 className="font-bold text-gray-900 mb-1">Assunto</h4>
                                            <p className="text-gray-600">{getFieldValue(selectedTask, FIELD_KEYS.ASSUNTO) || '-'}</p>
                                        </div>
                                        <div>
                                            <h4 className="font-bold text-gray-900 mb-1">Data Entrega</h4>
                                            <p className="text-gray-600">{formatDate(getFieldValue(selectedTask, FIELD_KEYS.DATA_ENTREGA))}</p>
                                        </div>
                                        <div className="col-span-1 md:col-span-2">
                                            <h4 className="font-bold text-gray-900 mb-1">Link Drive</h4>
                                            {getFieldValue(selectedTask, FIELD_KEYS.LINK_DRIVE) ? (
                                                <a href={getFieldValue(selectedTask, FIELD_KEYS.LINK_DRIVE)} target="_blank" className="text-blue-600 hover:underline flex items-center gap-1">
                                                    <Icon name="Link" size={14} /> Abrir Link
                                                </a>
                                            ) : <span className="text-gray-400">Nenhum link</span>}
                                        </div>
                                    </div>

                                    {/* Description/Observation */}
                                    <div>
                                        <h4 className="text-sm font-bold text-gray-900 mb-2 border-b pb-1">Observação / Descrição</h4>
                                        <p className="text-sm text-gray-700 leading-relaxed whitespace-pre-wrap bg-gray-50 p-3 rounded-md border border-gray-100">
                                            {getFieldValue(selectedTask, FIELD_KEYS.OBSERVACAO) || 'Sem observações.'}
                                        </p>
                                    </div>

                                    {/* Comments */}
                                    <div>
                                        <h4 className="text-sm font-bold text-gray-900 mb-2 flex items-center gap-2">
                                            <Icon name="MessageSquare" size={16} /> Comentários
                                        </h4>
                                        <div className="space-y-2 max-h-40 overflow-y-auto pr-2 custom-scrollbar">
                                            {String(getFieldValue(selectedTask, FIELD_KEYS.COMENTARIOS, '')).split('\n').map((c, i) => (
                                                c.trim() && (
                                                    <div key={i} className="text-xs bg-yellow-50 p-2 rounded border border-yellow-100 text-gray-700">
                                                        {c}
                                                    </div>
                                                )
                                            ))}
                                            {!getFieldValue(selectedTask, FIELD_KEYS.COMENTARIOS) && <span className="text-xs text-gray-400 italic">Nenhum comentário.</span>}
                                        </div>
                                    </div>
                                </div>

                                {/* Modal Actions */}
                                <div className="p-4 border-t border-gray-200 bg-gray-50 flex flex-col sm:flex-row gap-3">
                                    <button 
                                        onClick={() => handleApprove(selectedTask, 'approve')}
                                        className="btn-action bg-green-600 text-white hover:bg-green-700 shadow-sm"
                                    >
                                        <Icon name="ThumbsUp" size={16} /> Aprovar
                                    </button>
                                    <button 
                                        onClick={() => handleApprove(selectedTask, 'reject')}
                                        className="btn-action bg-red-600 text-white hover:bg-red-700 shadow-sm"
                                    >
                                        <Icon name="ThumbsDown" size={16} /> Reprovar
                                    </button>
                                    <button 
                                        onClick={() => handleComment(selectedTask)}
                                        className="btn-action bg-primary text-white hover:bg-primary/90 shadow-sm"
                                    >
                                        <Icon name="MessageCircle" size={16} /> Comentar
                                    </button>
                                    <button 
                                        onClick={() => handleApprove(selectedTask, 'custom')}
                                        className="btn-action bg-white border border-gray-300 text-gray-700 hover:bg-gray-100"
                                    >
                                        <Icon name="Edit" size={16} /> Status Personalizado
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* --- FEEDBACK TOAST --- */}
                    {modalMessage && (
                        <div className="fixed bottom-8 left-1/2 transform -translate-x-1/2 z-[100] animate-fadeInUp">
                            <div className={`px-6 py-3 rounded-full shadow-xl flex items-center gap-3 font-medium text-white ${
                                modalMessage.type === 'loading' ? 'bg-primary' : 
                                modalMessage.type === 'error' ? 'bg-red-600' : 'bg-green-600'
                            }`}>
                                {modalMessage.type === 'loading' && <div className="w-4 h-4 border-2 border-white/50 border-t-white rounded-full animate-spin"></div>}
                                {modalMessage.type === 'success' && <Icon name="Check" size={18} />}
                                {modalMessage.type === 'error' && <Icon name="AlertTriangle" size={18} />}
                                <span>{modalMessage.text}</span>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
